<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Commodity Price Dashboard</title>
<style>
body { margin:0; font-family:"Segoe UI",sans-serif; background:linear-gradient(to right,#56ab2f,#a8e063); color:#fff; text-align:center; }
header { background: rgba(0,0,0,0.5); padding:1rem; box-shadow:0px 4px 8px rgba(0,0,0,0.3); }
header h1 { margin:0; font-size:2rem; }
nav button { margin-top:10px; padding:0.6rem 1.2rem; border:none; border-radius:6px; background:#ffd700; color:#333; font-weight:bold; cursor:pointer; transition:0.3s; }
nav button:hover { background:#ffb300; }
.form-section { background: rgba(255,255,255,0.15); padding:20px; margin:20px auto; width:80%; border-radius:12px; backdrop-filter: blur(10px); }
form select, form input, form button { margin:10px; padding:10px; border-radius:6px; border:none; font-size:1rem; }
form select, form input { width:220px; }
form input[readonly] { background: rgba(255,255,255,0.3); color:#fff; font-weight:bold; }
form button { background:#ff9800; color:#fff; cursor:pointer; }
form button:hover { background:#e68900; }
#msg { margin-top:15px; font-size:1.4rem; font-weight:bold; color:#ffeb3b; }
.table-section { margin:20px auto; width:90%; background: rgba(0,0,0,0.4); border-radius:10px; padding:20px; overflow:auto; max-height:0; transition:max-height 0.5s ease; }
.table-section table { width:100%; border-collapse:collapse; margin-top:10px; }
th, td { padding:12px; border:1px solid rgba(255,255,255,0.3); }
th { background: rgba(255,255,255,0.2); }
footer { margin-top:30px; padding:10px; background: rgba(0,0,0,0.5); font-size:0.9rem; }
#metricsSection img { max-width: 100%; height: 400px; object-fit: contain; margin-top: 10px; border-radius: 8px; }

#metricsSection div { font-size: 1.2rem; margin:5px 0; }
</style>
</head>
<body>

<header>
  <h1>🌾 Commodity Price Dashboard</h1>
  <nav>
    <button id="toggleDataBtn" onclick="toggleData()">📊 View Market Data</button>
  </nav>
</header>

<main>
  <!-- Prediction Form -->
  <section class="form-section">
    <h2>🔮 Predict Modal Price</h2>
    <form id="predictForm">
      <select name="state" id="state"><option value="">Select State</option></select>
      <select name="district" id="district"><option value="">Select District</option></select>
      <select name="market" id="market"><option value="">Select Market</option></select>
      <select name="commodity" id="commodity"><option value="">Select Commodity</option></select>
      <select name="variety" id="variety"><option value="">Select Variety</option></select>
      <input type="number" id="min_price" placeholder="Min Price" readonly>
      <input type="number" id="max_price" placeholder="Max Price" readonly>
      <button type="submit">✨ Predict</button>
    </form>
    <div id="msg"></div>
  </section>

  <!-- Model Metrics -->
  <section class="form-section" id="metricsSection">
    <h2>📈 Model Accuracy & Graph</h2>
    <div id="accuracy"></div>
    <div id="mae"></div>
    <div id="rmse"></div>
    <img id="accuracyGraph">
  </section>

  <!-- Market Data Table -->
  <section class="table-section" id="dataSection">
    <h2>📑 Market Data</h2>
    <table id="dataTable">
      <thead>
        <tr>
          <th>State</th><th>District</th><th>Market</th><th>Commodity</th><th>Variety</th><th>Min</th><th>Max</th><th>Modal</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<footer>
  <p>🌱 Developed by <b>Geattam Dhanush</b> | Data Science Dashboard</p>
</footer>

<script>
let allData = [];

// Populate dropdowns
async function populateDropdowns() {
  const res = await fetch("/data");
  allData = await res.json();
  fillOptions("state",[...new Set(allData.map(r=>r.state))]);
}

function fillOptions(id, items){
  const select=document.getElementById(id);
  const current=select.value;
  select.innerHTML=`<option value="">Select ${id.charAt(0).toUpperCase()+id.slice(1)}</option>`;
  items.forEach(v=>{
    const opt=document.createElement("option");
    opt.value=v; opt.textContent=v;
    select.appendChild(opt);
  });
  if(items.includes(current)) select.value=current;
}

function filterDropdowns(){
  const state=document.getElementById("state").value;
  const district=document.getElementById("district").value;
  const market=document.getElementById("market").value;
  const commodity=document.getElementById("commodity").value;

  if(state){
    fillOptions("district",[...new Set(allData.filter(r=>r.state===state).map(r=>r.district))]);
  }
  if(state && district){
    fillOptions("market",[...new Set(allData.filter(r=>r.state===state && r.district===district).map(r=>r.market))]);
  }
  if(state && district && market){
    fillOptions("commodity",[...new Set(allData.filter(r=>r.state===state && r.district===district && r.market===market).map(r=>r.commodity))]);
  }
  if(state && district && market && commodity){
    fillOptions("variety",[...new Set(allData.filter(r=>r.state===state && r.district===district && r.market===market && r.commodity===commodity).map(r=>r.variety))]);
  }

  updatePrices();
}

function updatePrices(){
  const state=document.getElementById("state").value;
  const district=document.getElementById("district").value;
  const market=document.getElementById("market").value;
  const commodity=document.getElementById("commodity").value;
  const variety=document.getElementById("variety").value;

  const filtered=allData.filter(r=>
    (!state || r.state===state)&&
    (!district || r.district===district)&&
    (!market || r.market===market)&&
    (!commodity || r.commodity===commodity)&&
    (!variety || r.variety===variety)
  );

  if(filtered.length>0){
    document.getElementById("min_price").value=Math.min(...filtered.map(r=>r.min_price));
    document.getElementById("max_price").value=Math.max(...filtered.map(r=>r.max_price));
  } else {
    document.getElementById("min_price").value="";
    document.getElementById("max_price").value="";
  }
}

["state","district","market","commodity","variety"].forEach(id=>{
  document.getElementById(id).addEventListener("change", filterDropdowns);
});

// Prediction
document.getElementById("predictForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const data={
    state: document.getElementById("state").value,
    district: document.getElementById("district").value,
    market: document.getElementById("market").value,
    commodity: document.getElementById("commodity").value,
    variety: document.getElementById("variety").value,
    min_price: parseFloat(document.getElementById("min_price").value),
    max_price: parseFloat(document.getElementById("max_price").value)
  };

  const res=await fetch("/predict",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(data)
  });
  const result=await res.json();
  if(result.predicted_modal_price){
    document.getElementById("msg").innerText=`Min: ₹${data.min_price} | Max: ₹${data.max_price} | Predicted Modal: ₹${result.predicted_modal_price}`;
  } else {
    document.getElementById("msg").innerText=`Error: ${result.error}`;
  }
});

// Load market table
async function loadData(){
  const tbody=document.querySelector("#dataTable tbody");
  tbody.innerHTML="";
  allData.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.state}</td><td>${r.district}</td><td>${r.market}</td><td>${r.commodity}</td><td>${r.variety}</td><td>${r.min_price}</td><td>${r.max_price}</td><td>${r.modal_price}</td>`;
    tbody.appendChild(tr);
  });
}

function toggleData(){
  const section=document.getElementById("dataSection");
  const btn=document.getElementById("toggleDataBtn");
  if(section.style.maxHeight===""||section.style.maxHeight==="0px"){
    loadData();
    section.style.maxHeight="800px";
    btn.textContent="❌ Close Market Data";
  } else {
    section.style.maxHeight="0";
    btn.textContent="📊 View Market Data";
  }
}

// Load metrics
async function loadMetrics(){
  const res=await fetch("/model_metrics");
  const data=await res.json();
  document.getElementById("accuracy").innerText=`R² Score: ${data.r2}%`;
  document.getElementById("mae").innerText=`MAE: ₹${data.mae}`;
  document.getElementById("rmse").innerText=`RMSE: ₹${data.rmse}`;
  document.getElementById("accuracyGraph").src=`data:image/png;base64,${data.graph}`;
}

// Initialize
window.addEventListener("DOMContentLoaded", ()=>{
  populateDropdowns();
  loadMetrics();
});
</script>
</body>
</html>
